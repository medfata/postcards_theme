<data-island x-data="CartItems" data-cart-items
  class="flex flex-auto flex-col {% unless template == 'cart' %}overflow-hidden overflow-y-auto{% endunless %}"
  on="idle">
  {% if settings.enable_free_shipping_progress_in_cart and template == 'cart' %}
  {% render 'free-shipping-progress' %}
  {% endif %}
  {% if cart != empty %}
  {%- liquid
  assign cart_item_grid_container = 'grid-cols-4 gap-2.5 xl:gap-5 auto-rows-max lg:auto-rows-min'

  if template == 'cart'
  assign cart_item_grid_container = cart_item_grid_container | append: ' lg:grid-cols-14'
  else
  assign cart_item_grid_container = cart_item_grid_container | append: ' lg:grid-cols-5'
  endif
  -%}
  <form action="{{ routes.cart_url }}" class="cart__contents critical-hidden" method="post" id="cart">
    <div class="flex-auto overflow-hidden overflow-y-auto pb-16">
      {% if template == 'cart' %}
      <div
        class="hidden lg:grid {{ cart_item_grid_container }} mb-5 items-end border-b-section border-scheme-text pb-5">
        <p class="justify-self-start lg:col-span-8">
          {{ 'cart.label.product' | t }}
        </p>
        <p class="justify-self-start lg:col-span-3">
          {{ 'cart.label.quantity' | t }}
        </p>
        <p class="justify-self-end lg:col-span-3">
          {{ 'cart.label.total' | t }}
        </p>
      </div>
      {% endif %}
      {% if settings.enable_free_shipping_progress_in_cart
      and template != 'cart'
      %}
      {% render 'free-shipping-progress' %}
      {% endif %}
      <ul :key="cart-items" class="gap-gutter grid grid-cols-1">
        {% for item in cart.items %}
        {% comment %} Skip shipping protection product in the main cart items display {% endcomment %}
        {% if item.variant.id != 49980872917265 %}
        {%- capture quantity -%}
        <div x-data="CartItemQuantity" x-ref="quantityControl" @remove="remove" class="max-w-min">
          <div
            class="ml-[0.1rem] {% if template == 'cart' %} lg:flex lg:justify-start lg:ml-0 {% else %}mt-2.5 lg:mt-5{% endif %}"
            style="margin-top: 1rem;">
            <label class="sr-only" for="updates_{{ item.key }}">
              {{- 'cart.label.quantity' | t }}:</label>
            <div
              class="flex h-8 max-w-min flex-nowrap items-stretch justify-center p-0 text-xs text-scheme-text lg:text-base">
              <button style="
                  background: #fff;
                  border: 1px solid #ddd;
                  width: 30px;
                  height: 30px;
                  min-height: 30px;
                  max-height: 30px;
                  text-align: center;
                  padding: 0;
                  cursor: pointer;
                  display: flex;
                  justify-content: center;
                  align-items: center;
                  color: #ddd;
                  transition: .2s background-color;" aria-label="&minus;" @click.prevent.stop="decrement">
                <div class="m-auto h-2 w-2 lg:h-4 lg:w-4" style="width: 12px !important;height: 12px !important;fill: #637381;">
                  {% render 'icon-subtract' %}
                </div>
              </button>
              <input type="number" name="updates[]" id="updates_{{ item.key }}" value="{{ item.quantity }}"
                data-variant-id="{{ item.variant_id }}" data-last-value="{{ item.quantity }}" style="width: 45px;
                  height: 30px;
                  border-radius: 0;
                  border-top: 1px solid #ddd;
                  border-bottom: 1px solid #ddd;
                  border-left: none;
                  border-right: none;
                  padding: 0;
                  margin: 0;
                  text-align: center;
                  background: #fff;
                  color: #000;
                  font-size: 14px;
                  opacity: 1;
                  min-height: 30px;
                  max-height: 30px;" size="4" min="1" step="1" aria-label="{{ 'cart.label.quantity' | t }}"
                x-ref="quantityInput" x-model.number.fill="quantity" @change="itemQuantityChange()"
                @keyup.debounce.750ms="$dispatch('change')" autocomplete="off">
              <button style="background: #fff;
                border: 1px solid #ddd;
                width: 30px;
                height: 30px;
                min-height: 30px;
                max-height: 30px;
                text-align: center;
                padding: 0;
                cursor: pointer;
                display: flex;
                justify-content: center;
                align-items: center;
                color: #ddd;
                transition: .2s background-color;" aria-label="&plus;" @click.prevent.stop="increment">
                <div class="m-auto h-2 w-2 lg:h-4 lg:w-4" style="width: 12px !important;height: 12px !important;fill: #637381;">
                  {% render 'icon-add' %}
                </div>
              </button>
            </div>
          </div>
        </div>
        {%- endcapture -%}
        
        {% comment %} Check if this is a bundled item by examining properties with '_' prefix {% endcomment %}
        {% assign is_bundle = false %}
        {% for p in item.properties %}
          {% assign first_character_in_key = p.first | slice: 0 %}
          {% if first_character_in_key == '_' %}
            {% assign image_data = p.first | remove_first: '_' | split: ':' %}
            {% if image_data.size > 1 %}
              {% assign is_bundle = true %}
              {% break %}
            {% endif %}
          {% endif %}
        {% endfor %}
        
        {% if template == 'cart' %}
        <!-- Cart page layout -->
        <li x-data="CartItem('{{ item.key }}')" :class="{ 'opacity-50 cursor-progress': locked }"
          key="CartItem-{{ forloop.index }}-{{ item.key }}" id="CartItem-{{ forloop.index }}-{{ item.key }}"
          data-line-item-key="{{ item.key }}" class="grid grid-cols-14 gap-2 items-start py-5 border-b border-scheme-text/10">
          
          <!-- Product image or bundle images -->
          <div class="col-span-4 lg:max-w-[166px]">
            {% if is_bundle %}
              <div class="bundle-items-grid">
                {% for p in item.properties %}
                  {% assign first_character_in_key = p.first | slice: 0 %}
                  {% if first_character_in_key == '_' %}
                    {% assign image_data = p.first | remove_first: '_' | split: ':' %}
                    {% if image_data.size > 1 %}
                      {% assign encoded_image = image_data[1] %}
                      <div class="bundle-item-cart">
                        <img src="{{ encoded_image | base64_decode }}" 
                             alt="{{ item.title }} bundle item" 
                             class="bundle-item-image-cart">
                      </div>
                    {% endif %}
                  {% endif %}
                {% endfor %}
              </div>
            {% elsif item.image != blank %}
              <a href="{{ item.url }}" class="block" aria-hidden="true" tabindex="-1">
                {{ item | image_url: width: 200 | image_tag: loading: 'eager', alt: item.title, class: 'w-full h-auto' }}
              </a>
            {% endif %}
          </div>
          
          <!-- Product details -->
          <div class="col-span-4 lg:pr-4">
            <a href="{{ item.url }}">
              <p class="text-sm leading-tight lg:text-base font-medium">{{ item.product.title }}</p>
              
              <p class="mt-1 text-sm">{{ item.price | money }}</p>
              
              {% unless item.product.has_only_default_variant %}
                <p class="mt-1 text-xs">{{ item.variant.title }}</p>
              {% endunless %}
              
              {% if settings.cart_vendor_enable %}
                <p class="text-xs">{{ item.vendor }}</p>
              {% endif %}
            </a>
            
            {% if item.line_level_discount_allocations != blank %}
              <ul class="mt-1 text-xs" aria-label="{{ 'customer.order.discount' | t }}">
                {%- for discount_allocation in item.line_level_discount_allocations -%}
                  <li class="order-discount__item">
                    <span class="-mx-1 inline-block rounded-button bg-scheme-accent-1 p-1 text-scheme-accent-1-contrast">
                      {{- discount_allocation.discount_application.title }}
                      {% if discount_allocation.amount > 0 -%}
                        (-{{ discount_allocation.amount | money }})
                      {%- endif -%}
                    </span>
                  </li>
                {%- endfor -%}
              </ul>
            {% endif %}
          </div>
          
          <!-- Quantity controls -->
          <div class="col-span-3">
            {{ quantity }}
          </div>
          
          <!-- Price and remove -->
          <div class="col-span-3 flex flex-col items-end">
            <button type="button" class="border-0 bg-transparent p-0 cursor-pointer mb-2" @click.prevent="removeItem()">
              <svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.28125 3.28125L3.86719 12.6562C3.89502 13.1979 4.28906 13.5938 4.80469 13.5938H10.1953C10.713 13.5938 11.0997 13.1979 11.1328 12.6562L11.7188 3.28125" stroke="#8F8F8F" stroke-width="0.9375" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M2.34375 3.28125H12.6562H2.34375Z" fill="#8F8F8F"></path>
                <path d="M2.34375 3.28125H12.6562" stroke="#8F8F8F" stroke-width="0.9375" stroke-miterlimit="10" stroke-linecap="round"></path>
                <path d="M9.60938 5.15625L9.375 11.7188M5.625 3.28125V2.10938C5.62473 2.01697 5.64273 1.92541 5.67797 1.83998C5.71321 1.75455 5.76499 1.67693 5.83034 1.61159C5.89568 1.54624 5.9733 1.49446 6.05873 1.45922C6.14416 1.42398 6.23571 1.40598 6.32812 1.40625H8.67188C8.76429 1.40598 8.85584 1.42398 8.94127 1.45922C9.0267 1.49446 9.10432 1.54624 9.16966 1.61159C9.23501 1.67693 9.28679 1.75455 9.32203 1.83998C9.35727 1.92541 9.37527 2.01697 9.375 2.10938V3.28125H5.625ZM7.5 5.15625V11.7188V5.15625ZM5.39062 5.15625L5.625 11.7188L5.39062 5.15625Z" stroke="#8F8F8F" stroke-width="0.9375" stroke-linecap="round" stroke-linejoin="round"></path>
              </svg>
            </button>
            
            {%- if item.original_line_price != item.final_line_price -%}
              <del class="block">{{- item.original_line_price | money -}}</del>
              <span class="mt-1 inline-block rounded-button bg-scheme-accent-1 p-1 text-scheme-accent-1-contrast">
                {{- item.final_line_price | money -}}
              </span>
            {%- else -%}
              <span>{{ item.original_line_price | money }}</span>
            {%- endif -%}
          </div>
          
          <div class="col-span-full mt-1" id="Line-item-error-{{ item.key }}" role="alert"
            data-item-title="{{ item.title | escape }}" style="display: none;" x-show="errorMessage">
            <div class="w-fit rounded-button bg-scheme-accent-1 px-2 py-1 text-xs text-scheme-accent-1-contrast"
              x-text="errorMessage"></div>
          </div>
        </li>
        
        {% else %}
        <!-- Cart drawer layout -->
        <li x-data="CartItem('{{ item.key }}')" :class="{ 'opacity-50 cursor-progress': locked }"
          key="CartItem-{{ forloop.index }}-{{ item.key }}" id="CartItem-{{ forloop.index }}-{{ item.key }}"
          data-line-item-key="{{ item.key }}" style="display: flex;flex-direction: row;gap: 10px;padding:20px 30px; border-bottom: 1px solid rgba(0, 0, 0, .1); justify-content: space-between;">
          
          <!-- Product image or bundle images -->
          <div class="col-span-1 lg:col-span-2 row-span-2">
            {% if is_bundle %}
              <div class="bundle-items-container" style="width: 104px; max-height: 301px;">
                {% for p in item.properties %}
                  {% assign first_character_in_key = p.first | slice: 0 %}
                  {% if first_character_in_key == '_' %}
                    {% assign image_data = p.first | remove_first: '_' | split: ':' %}
                    {% if image_data.size > 1 %}
                      {% assign image_index = image_data[0] | plus: 0 %}
                      {% assign encoded_image = image_data[1] %}
                      {% assign item_number = image_index | plus: 1 %}
                      {% assign item_name_key = 'Item ' | append: item_number %}
                      {% assign item_name = item.properties[item_name_key] %}
                      
                      <div class="bundle-item">
                        <img src="{{ encoded_image | base64_decode }}" 
                             alt="{{ item_name }}" 
                             class="bundle-item-image w-full h-auto rounded-md border border-scheme-text/10">
                      </div>
                    {% endif %}
                  {% endif %}
                {% endfor %}
              </div>
            {% elsif item.image != blank %}
              <a href="{{ item.url }}" class="block" aria-hidden="true" tabindex="-1"
                style="width: 104px; height: 104px;">
                {{
                item
                | image_url: width: 200
                | image_tag:
                loading: 'eager',
                alt: item.title,
                sizes: '(min-width: 48em) 5rem, 3.5rem'
                }}
              </a>
            {% endif %}
          </div>
          
          <div class="col-span-2 lg:col-span-6 lg:row-span-3">
            <div>
              <a href="{{ item.url }}">
                <div data-product-title>
                  <p class="text-sm leading-tight lg:text-base">
                    {{ item.product.title }}
                  </p>

                  {% if template == 'cart' %}
                  <p class="mt-1 text-sm">
                    {% if item.original_line_price != item.line_price %}
                    <span class="visually-hidden">
                      {{- 'cart.label.discounted_price' | t -}}
                    </span>
                    {{ item.price | money }}
                    <span class="visually-hidden">
                      {{- 'cart.label.original_price' | t -}}
                    </span>
                    <s>{{ item.original_price | money }}</s>
                    {% else %}
                    {{ item.price | money }}
                    {% endif %}
                  </p>
                  {% endif %}

                  {% unless item.product.has_only_default_variant %}
                  <p class="mt-1 text-xs">{{ item.variant.title }}</p>
                  {% endunless %}
                </div>

                {% if settings.cart_vendor_enable %}
                <p class="text-xs">{{ item.vendor }}</p>
                {% endif %}

                {% if item.selling_plan_allocation %}
                <p class="text-xs">
                  {{ item.selling_plan_allocation.selling_plan.name }}
                </p>
                {% endif %}

                {% unless item.properties == empty %}
                {% for p in item.properties %}
                {% assign first_character_in_key = p.first | slice: 0 %}
                {% unless p.last == blank
                or first_character_in_key == '_'
                %}
                <p class="text-xs">
                  {{ p.first }}:
                  {% if p.last contains '/uploads/' %}
                  <a href="{{ p.last }}">
                    {{- p.last | split: '/' | last -}}
                  </a>
                  {% else %}
                  {{ p.last }}
                  {% endif %}
                </p>
                {% endunless %}
                {% endfor %}
                {% endunless %}
              </a>
              {%- if item.line_level_discount_allocations != blank
              or item.unit_price_measurement
              -%}
              <div {% if template=='cart' %} class="lg:mb-1" {% endif %}>
                {%- if item.line_level_discount_allocations != blank -%}
                <ul class="mt-1 text-xs" aria-label="{{ 'customer.order.discount' | t }}">
                  {%- for discount_allocation in item.line_level_discount_allocations -%}
                  <li class="order-discount__item">
                    <span
                      class="-mx-1 inline-block rounded-button bg-scheme-accent-1 p-1 text-scheme-accent-1-contrast">
                      {{- discount_allocation.discount_application.title }}
                      {% if discount_allocation.amount > 0 -%}
                      (-{{ discount_allocation.amount | money }})
                      {%- endif -%}
                    </span>
                  </li>
                  {%- endfor -%}
                </ul>
                {%- endif -%}
                {%- if item.unit_price_measurement -%}
                <div
                  class="text-xs {% if item.original_price != item.final_price %} inline-block bg-scheme-accent-1 text-scheme-accent-1-contrast p-1 rounded-button -mx-1 {% else %} text-scheme-text {% endif %}">
                  {{ item.unit_price | money }} /&nbsp;
                  {%- if item.unit_price_measurement.reference_value
                  != 1
                  -%}
                  {{- item.unit_price_measurement.reference_value -}}
                  {%- endif -%}
                  {{ item.unit_price_measurement.reference_unit }}
                </div>
                {%- endif -%}
              </div>
              {%- endif -%}
            </div>

            {%- unless template == 'cart' -%}
            {{ quantity }}
            {%- endunless -%}
          </div>
          
          <div class="flex flex-col justify-between items-end">
            <button type="button" class="border-0 bg-transparent p-0 cursor-pointer" @click.prevent="removeItem()">
              <svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M3.28125 3.28125L3.86719 12.6562C3.89502 13.1979 4.28906 13.5938 4.80469 13.5938H10.1953C10.713 13.5938 11.0997 13.1979 11.1328 12.6562L11.7188 3.28125"
                  stroke="#8F8F8F" stroke-width="0.9375" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M2.34375 3.28125H12.6562H2.34375Z" fill="#8F8F8F"></path>
                <path d="M2.34375 3.28125H12.6562" stroke="#8F8F8F" stroke-width="0.9375" stroke-miterlimit="10"
                  stroke-linecap="round"></path>
                <path
                  d="M9.60938 5.15625L9.375 11.7188M5.625 3.28125V2.10938C5.62473 2.01697 5.64273 1.92541 5.67797 1.83998C5.71321 1.75455 5.76499 1.67693 5.83034 1.61159C5.89568 1.54624 5.9733 1.49446 6.05873 1.45922C6.14416 1.42398 6.23571 1.40598 6.32812 1.40625H8.67188C8.76429 1.40598 8.85584 1.42398 8.94127 1.45922C9.0267 1.49446 9.10432 1.54624 9.16966 1.61159C9.23501 1.67693 9.28679 1.75455 9.32203 1.83998C9.35727 1.92541 9.37527 2.01697 9.375 2.10938V3.28125H5.625ZM7.5 5.15625V11.7188V5.15625ZM5.39062 5.15625L5.625 11.7188L5.39062 5.15625Z"
                  stroke="#8F8F8F" stroke-width="0.9375" stroke-linecap="round" stroke-linejoin="round"></path>
              </svg>
            </button>
            {%- if item.original_line_price != item.final_line_price -%}
            <del class="block">
              {{- item.original_line_price | money -}}
            </del>
            <span class="mt-1 inline-block rounded-button bg-scheme-accent-1 p-1 text-scheme-accent-1-contrast">
              {{- item.final_line_price | money -}}
            </span>
            {%- else -%}
            <span>{{ item.original_line_price | money }}</span>
            {%- endif -%}
          </div>
          
          <div class="col-span-full mt-1" id="Line-item-error-{{ item.key }}" role="alert"
            data-item-title="{{ item.title | escape }}" style="display: none;" x-show="errorMessage">
            <div class="w-fit rounded-button bg-scheme-accent-1 px-2 py-1 text-xs text-scheme-accent-1-contrast"
              x-text="errorMessage"></div>
          </div>
        </li>
        {% endif %}
        {% endif %}
        {% endfor %}
      </ul>
      
      {% comment %} Keep shipping protection items in the form but hidden from view {% endcomment %}
      {% for item in cart.items %}
        {% if item.variant.id == 49980872917265 %}
          <input type="hidden" name="updates[]" value="{{ item.quantity }}" id="hidden_updates_{{ item.key }}">
        {% endif %}
      {% endfor %}
      
      {% if settings.cart_notes_enable and template != 'cart' %}
      <div style="padding: 0px 30px"
        class="row-start-2 {% if template == 'cart' %} md:row-auto {% endif %} col-span-14 {% if template == 'cart' %} md:col-span-8 {% endif %} my-4 {% if template == 'cart' %} md:my-0 {% endif %}">
        <label class="block text-xs" for="CartSpecialInstructions">
          {{- 'cart.general.note' | t -}}
        </label>
        <data-island class="contents" x-data="CartNote">
          <textarea name="note" id="CartSpecialInstructions" class="input mb-2 mt-1 block w-full p-2 transition-opacity" style="box-shadow: none; border: 1px solid rgba(0, 0, 0, .1);"
            :class="{ 'opacity-50 cursor-progress' : updating }" :readonly="updating" @change="updateNote"
            @keyup.debounce.750ms="$dispatch('change')">
                {{- cart.note -}}
              </textarea>
        </data-island>
      </div>
      {% endif %}
    </div>
  </form>
  {% else %}
  <div style="height: 100%;display: flex;justify-content: center;align-items: center;">
    <p>{{ 'cart.general.empty' | t }}</p>
  </div>
  {% endif %}
</data-island>
<p class="sr-only" id="cart-live-region-text" aria-live="polite" role="status" aria-hidden="true">
  {{ 'cart.general.new_subtotal' | t }}:
  {{ cart.total_price | money_with_currency }}
</p>

<style>
  /* Bundle items for drawer cart */
  .bundle-items-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
    gap: 8px;
    overflow-y: auto;
  }
  
  .bundle-item {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .bundle-item-image {
    width: 100%;
    height: auto;
    object-fit: contain;
    border-radius: 4px;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  /* Bundle items for cart page */
  .bundle-items-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    width: 100%;
    max-height: 300px;
    overflow-y: auto;
  }
  
  .bundle-item-cart {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .bundle-item-image-cart {
    width: 100%;
    height: auto;
    object-fit: contain;
    border-radius: 4px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    aspect-ratio: 1/1;
  }
  
  @media (max-width: 767px) {
    .bundle-items-container {
      width: 80px;
      max-height: 200px;
      gap: 4px;
    }
    
    .bundle-items-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 4px;
      width: 100%;
      max-width: 120px;
      max-height: 150px;
    }
    
    .bundle-item-image-cart {
      max-width: 100%;
    }
  }
</style>